<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة الاختبارات الذكية - الطالب والمعلم</title>
    
    <!-- المكتبات الخارجية -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    
    <style>
        /* ===== متغيرات التصميم ===== */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --dark-gradient: linear-gradient(135deg, #434343 0%, #000000 100%);
            --light-bg: #f8fafc;
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-dark: #2d3748;
            --text-light: #718096;
            --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 10px 20px rgba(0, 0, 0, 0.08);
            --shadow-sm: 0 4px 12px rgba(0, 0, 0, 0.05);
            --radius-xl: 20px;
            --radius-lg: 15px;
            --radius-md: 10px;
            --radius-sm: 8px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* ===== الأنماط العامة ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', sans-serif;
        }
        
        body {
            background: var(--light-bg);
            min-height: 100vh;
            color: var(--text-dark);
            background-image: 
                radial-gradient(at 40% 20%, rgba(102, 126, 234, 0.1) 0px, transparent 50%),
                radial-gradient(at 80% 0%, rgba(118, 75, 162, 0.1) 0px, transparent 50%),
                radial-gradient(at 0% 50%, rgba(67, 233, 123, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(250, 112, 154, 0.1) 0px, transparent 50%);
        }
        
        /* ===== شاشة التحميل ===== */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-gradient);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        
        .splash-logo {
            width: 120px;
            height: 120px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            animation: pulse 2s infinite;
        }
        
        .splash-logo i {
            font-size: 60px;
            color: white;
        }
        
        .splash-text {
            color: white;
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 10px;
            text-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .splash-subtext {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.2rem;
            margin-bottom: 40px;
        }
        
        .loader {
            display: flex;
            gap: 10px;
        }
        
        .loader-dot {
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }
        
        .loader-dot:nth-child(1) { animation-delay: -0.32s; }
        .loader-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        /* ===== زر المعلم الثابت ===== */
        .teacher-access-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: var(--dark-gradient);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-lg);
            transition: var(--transition);
        }
        
        .teacher-access-btn:hover {
            transform: translateY(-3px) scale(1.1);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }
        
        /* ===== نافذة كلمة المرور ===== */
        .password-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .password-modal.active {
            display: flex;
        }
        
        .password-card {
            background: var(--card-bg);
            padding: 40px;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            width: 90%;
            max-width: 400px;
            text-align: center;
            transform: translateY(20px);
            opacity: 0;
            animation: slideUp 0.3s ease forwards;
        }
        
        @keyframes slideUp {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .password-card h2 {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }
        
        .password-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e2e8f0;
            border-radius: var(--radius-md);
            font-size: 1.1rem;
            margin: 20px 0;
            transition: var(--transition);
        }
        
        .password-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .password-error {
            color: #f56565;
            margin-top: 10px;
            display: none;
        }
        
        /* ===== الواجهة الرئيسية (الطالب) ===== */
        .student-container {
            min-height: 100vh;
            padding: 40px 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 50px;
        }
        
        .header h1 {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2.8rem;
            margin-bottom: 10px;
            font-weight: 800;
        }
        
        .header p {
            color: var(--text-light);
            font-size: 1.2rem;
            max-width: 600px;
            margin: 0 auto;
        }
        
        /* ===== كارد الدخول للطالب ===== */
        .login-card {
            background: var(--card-bg);
            border-radius: var(--radius-xl);
            padding: 50px;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(10px);
            max-width: 500px;
            margin: 0 auto;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .login-icon {
            width: 80px;
            height: 80px;
            background: var(--primary-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
        }
        
        .login-icon i {
            font-size: 36px;
            color: white;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-dark);
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .form-input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e2e8f0;
            border-radius: var(--radius-md);
            font-size: 1.1rem;
            transition: var(--transition);
            background: white;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
        }
        
        .btn {
            padding: 16px 40px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            width: 100%;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        /* ===== صفحة الاختبار ===== */
        .exam-container {
            display: none;
        }
        
        .exam-header {
            background: var(--card-bg);
            border-radius: var(--radius-xl);
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-md);
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
        }
        
        .exam-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
        }
        
        .info-label {
            color: var(--text-light);
            font-size: 0.95rem;
            margin-bottom: 5px;
        }
        
        .info-value {
            color: var(--text-dark);
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .exam-timer {
            background: var(--warning-gradient);
            color: white;
            padding: 20px;
            border-radius: var(--radius-lg);
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        /* ===== الأسئلة ===== */
        .question-card {
            background: var(--card-bg);
            border-radius: var(--radius-xl);
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-md);
            border-left: 6px solid #667eea;
            display: none;
        }
        
        .question-card.active {
            display: block;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .question-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .question-number {
            background: var(--primary-gradient);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
            margin-left: 20px;
        }
        
        .question-text {
            font-size: 1.3rem;
            line-height: 1.6;
            color: var(--text-dark);
        }
        
        .options-container {
            margin: 30px 0;
        }
        
        .option-label {
            display: block;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid #e2e8f0;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }
        
        .option-label:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }
        
        .option-label.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }
        
        .option-input {
            margin-left: 10px;
        }
        
        .option-text {
            font-size: 1.1rem;
            color: var(--text-dark);
        }
        
        /* ===== أدوات التحكم ===== */
        .exam-controls {
            background: var(--card-bg);
            border-radius: var(--radius-xl);
            padding: 30px;
            box-shadow: var(--shadow-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .progress-bar {
            flex: 1;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 0 30px;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--primary-gradient);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* ===== واجهة المعلم ===== */
        .teacher-container {
            display: none;
            min-height: 100vh;
            padding: 20px;
            background: var(--light-bg);
        }
        
        .teacher-header {
            background: var(--dark-gradient);
            color: white;
            padding: 30px;
            border-radius: var(--radius-xl);
            margin-bottom: 30px;
            box-shadow: var(--shadow-lg);
        }
        
        .teacher-nav {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-md);
        }
        
        .teacher-tabs {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 10px;
        }
        
        .teacher-tab {
            padding: 15px 30px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
            font-weight: 600;
            color: var(--text-light);
        }
        
        .teacher-tab:hover {
            border-color: #667eea;
            color: #667eea;
        }
        
        .teacher-tab.active {
            background: var(--primary-gradient);
            color: white;
            border-color: transparent;
        }
        
        .teacher-content {
            display: none;
        }
        
        .teacher-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* ===== كروت المعلم ===== */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .dashboard-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 30px;
            box-shadow: var(--shadow-md);
            transition: var(--transition);
            text-align: center;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        .card-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 28px;
            color: white;
        }
        
        .icon-students { background: var(--primary-gradient); }
        .icon-questions { background: var(--secondary-gradient); }
        .icon-exams { background: var(--success-gradient); }
        .icon-results { background: var(--warning-gradient); }
        
        .card-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 10px 0;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* ===== الجداول ===== */
        .table-container {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 30px;
            box-shadow: var(--shadow-md);
            overflow-x: auto;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            background: rgba(102, 126, 234, 0.1);
            padding: 15px;
            text-align: right;
            color: var(--text-dark);
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .data-table td {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .data-table tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }
        
        /* ===== الأزرار ===== */
        .btn-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            color: white;
            margin: 0 5px;
        }
        
        .btn-edit { background: #48bb78; }
        .btn-delete { background: #f56565; }
        .btn-view { background: #4299e1; }
        .btn-correct { background: #ed8936; }
        .btn-print { background: #9f7aea; }
        
        .btn-icon:hover {
            transform: scale(1.1);
        }
        
        /* ===== استيراد إكسل ===== */
        .excel-upload {
            border: 3px dashed #cbd5e0;
            border-radius: var(--radius-lg);
            padding: 50px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .excel-upload:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }
        
        .excel-icon {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 20px;
        }
        
        /* ===== لوحة تصحيح المقالي ===== */
        .correction-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }
        
        .correction-modal.active {
            display: flex;
        }
        
        .correction-container {
            background: var(--card-bg);
            width: 95%;
            height: 90vh;
            border-radius: var(--radius-xl);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .correction-header {
            background: var(--dark-gradient);
            color: white;
            padding: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .correction-body {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            gap: 30px;
        }
        
        .student-info-panel {
            flex: 1;
            max-width: 300px;
            background: white;
            border-radius: var(--radius-lg);
            padding: 25px;
            box-shadow: var(--shadow-md);
        }
        
        .answer-panel {
            flex: 2;
            background: white;
            border-radius: var(--radius-lg);
            padding: 30px;
            box-shadow: var(--shadow-md);
            position: relative;
        }
        
        .score-controls {
            position: absolute;
            right: 30px;
            top: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .score-input {
            width: 100px;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: var(--radius-md);
            font-size: 1.2rem;
            text-align: center;
        }
        
        .navigation-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        
        .nav-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: var(--primary-gradient);
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .nav-btn:hover {
            transform: scale(1.1);
        }
        
        /* ===== التأثيرات الخاصة ===== */
        .floating-shapes {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        .shape {
            position: absolute;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            animation: float 15s infinite ease-in-out;
        }
        
        .shape:nth-child(1) {
            width: 300px;
            height: 300px;
            top: 10%;
            left: 5%;
            animation-delay: 0s;
        }
        
        .shape:nth-child(2) {
            width: 200px;
            height: 200px;
            top: 60%;
            right: 10%;
            animation-delay: 5s;
        }
        
        .shape:nth-child(3) {
            width: 150px;
            height: 150px;
            bottom: 20%;
            left: 20%;
            animation-delay: 10s;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(10deg); }
        }
        
        /* ===== التنبيهات ===== */
        .alert {
            padding: 20px;
            border-radius: var(--radius-md);
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideInRight 0.3s ease;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .alert-success {
            background: linear-gradient(135deg, rgba(67, 233, 123, 0.1), rgba(56, 249, 215, 0.1));
            border-right: 4px solid #43e97b;
            color: #22543d;
        }
        
        .alert-error {
            background: linear-gradient(135deg, rgba(245, 101, 101, 0.1), rgba(254, 178, 178, 0.1));
            border-right: 4px solid #f56565;
            color: #742a2a;
        }
        
        .alert-warning {
            background: linear-gradient(135deg, rgba(250, 112, 154, 0.1), rgba(254, 225, 64, 0.1));
            border-right: 4px solid #fa709a;
            color: #744210;
        }
        
        /* ===== التجاوبية ===== */
        @media (max-width: 768px) {
            .student-container,
            .teacher-container {
                padding: 20px 15px;
            }
            
            .login-card {
                padding: 30px 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .exam-header {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .exam-info-grid {
                grid-template-columns: 1fr;
            }
            
            .question-card {
                padding: 25px;
            }
            
            .dashboard-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .correction-body {
                flex-direction: column;
            }
            
            .student-info-panel {
                max-width: 100%;
            }
            
            .teacher-tabs {
                flex-wrap: wrap;
            }
            
            .teacher-tab {
                flex: 1;
                min-width: 120px;
                text-align: center;
            }
        }
        
        @media (max-width: 480px) {
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .exam-controls {
                flex-direction: column;
                gap: 20px;
            }
            
            .progress-bar {
                width: 100%;
                margin: 10px 0;
            }
        }
    </style>
</head>
<body>
    <!-- ===== الأشكال العائمة ===== -->
    <div class="floating-shapes">
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
    </div>
    
    <!-- ===== شاشة التحميل ===== -->
    <div class="splash-screen" id="splashScreen">
        <div class="splash-logo">
            <i class="fas fa-graduation-cap"></i>
        </div>
        <div class="splash-text">منصة الاختبارات الذكية</div>
        <div class="splash-subtext">التعلم الذكي لمستقبل أفضل</div>
        <div class="loader">
            <div class="loader-dot"></div>
            <div class="loader-dot"></div>
            <div class="loader-dot"></div>
        </div>
    </div>
    
    <!-- ===== زر الوصول للمعلم ===== -->
    <button class="teacher-access-btn" onclick="showTeacherLogin()">
        <i class="fas fa-chalkboard-teacher"></i>
    </button>
    
    <!-- ===== نافذة كلمة مرور المعلم ===== -->
    <div class="password-modal" id="teacherPasswordModal">
        <div class="password-card">
            <h2><i class="fas fa-lock"></i> الدخول لوحة المعلم</h2>
            <p>أدخل كلمة المرور للوصول إلى لوحة التحكم</p>
            <input type="password" class="password-input" id="teacherPassword" placeholder="أدخل كلمة المرور" autocomplete="off">
            <div class="password-error" id="passwordError">
                <i class="fas fa-exclamation-circle"></i> كلمة المرور غير صحيحة
            </div>
            <button class="btn btn-primary" onclick="checkTeacherPassword()">
                <i class="fas fa-sign-in-alt"></i> الدخول
            </button>
            <div style="margin-top: 20px; font-size: 0.9rem; color: #718096;">
                كلمة المرور الافتراضية: <strong>112233</strong>
            </div>
        </div>
    </div>
    
    <!-- ===== واجهة الطالب ===== -->
    <div class="student-container" id="studentContainer">
        <div class="header">
            <h1><i class="fas fa-graduation-cap"></i> منصة الاختبارات الإلكترونية</h1>
            <p>اختبارات ذكية، نتائج فورية، تعليم متطور</p>
        </div>
        
        <!-- شاشة دخول الطالب -->
        <div class="login-card" id="studentLoginScreen">
            <div class="login-icon">
                <i class="fas fa-user-graduate"></i>
            </div>
            <h2 style="text-align: center; margin-bottom: 30px; color: var(--text-dark);">
                تسجيل دخول الطالب
            </h2>
            
            <div class="alert alert-warning" id="loginAlert" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <span id="alertMessage"></span>
            </div>
            
            <div class="form-group">
                <label class="form-label">الرقم المدني</label>
                <input type="text" class="form-input" id="studentCivilId" 
                       placeholder="أدخل الرقم المدني" maxlength="10">
            </div>
            
            <div class="form-group">
                <label class="form-label">كود الاختبار</label>
                <input type="text" class="form-input" id="examCode" 
                       placeholder="أدخل كود الاختبار (رقم أو رقمين)" maxlength="4">
            </div>
            
            <button class="btn btn-primary" onclick="studentLogin()">
                <i class="fas fa-sign-in-alt"></i> دخول الاختبار
            </button>
            
            <div style="text-align: center; margin-top: 20px; color: #718096; font-size: 0.9rem;">
                <i class="fas fa-info-circle"></i> يمكنك الدخول للاختبار مرة واحدة فقط
            </div>
        </div>
        
        <!-- صفحة الاختبار -->
        <div class="exam-container" id="examContainer">
            <div class="exam-header">
                <div>
                    <div class="exam-info-grid">
                        <div class="info-item">
                            <span class="info-label">الطالب</span>
                            <span class="info-value" id="examStudentName">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">الاختبار</span>
                            <span class="info-value" id="examTestName">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">المادة</span>
                            <span class="info-value" id="examSubject">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">كود الاختبار</span>
                            <span class="info-value" id="examCodeDisplay">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">الصف</span>
                            <span class="info-value" id="examClass">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">العام الدراسي</span>
                            <span class="info-value" id="examYear">1445هـ</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">مدة الاختبار</span>
                            <span class="info-value" id="examDuration">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">عدد الأسئلة</span>
                            <span class="info-value" id="examQuestionsCount">-</span>
                        </div>
                    </div>
                </div>
                <div class="exam-timer" id="examTimer">
                    <i class="fas fa-clock"></i>
                    <span id="timeRemaining">60:00</span>
                </div>
            </div>
            
            <div id="questionsContainer"></div>
            
            <div class="exam-controls">
                <button class="btn btn-primary" onclick="previousQuestion()" id="prevBtn">
                    <i class="fas fa-arrow-right"></i> السابق
                </button>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                
                <button class="btn btn-primary" onclick="nextQuestion()" id="nextBtn">
                    التالي <i class="fas fa-arrow-left"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- ===== واجهة المعلم ===== -->
    <div class="teacher-container" id="teacherContainer">
        <div class="teacher-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 style="color: white; margin-bottom: 10px;">
                        <i class="fas fa-chalkboard-teacher"></i> لوحة تحكم المعلم
                    </h1>
                    <p style="color: rgba(255, 255, 255, 0.9);">
                        إدارة الطلاب، الاختبارات، النتائج والتحليلات
                    </p>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="switchToStudentMode()" 
                            style="background: rgba(255, 255, 255, 0.2); border: 2px solid white;">
                        <i class="fas fa-user-graduate"></i> العودة للطلاب
                    </button>
                </div>
            </div>
        </div>
        
        <div class="teacher-nav">
            <div class="teacher-tabs">
                <button class="teacher-tab active" onclick="showTeacherTab('dashboard')">
                    <i class="fas fa-tachometer-alt"></i> لوحة التحكم
                </button>
                <button class="teacher-tab" onclick="showTeacherTab('students')">
                    <i class="fas fa-users"></i> إدارة الطلاب
                </button>
                <button class="teacher-tab" onclick="showTeacherTab('questions')">
                    <i class="fas fa-question-circle"></i> إنشاء الأسئلة
                </button>
                <button class="teacher-tab" onclick="showTeacherTab('exams')">
                    <i class="fas fa-file-alt"></i> إدارة الاختبارات
                </button>
                <button class="teacher-tab" onclick="showTeacherTab('results')">
                    <i class="fas fa-chart-bar"></i> النتائج والتصحيح
                </button>
                <button class="teacher-tab" onclick="showTeacherTab('settings')">
                    <i class="fas fa-cog"></i> الإعدادات
                </button>
            </div>
        </div>
        
        <!-- لوحة التحكم -->
        <div class="teacher-content active" id="dashboardTab">
            <div class="dashboard-cards">
                <div class="dashboard-card">
                    <div class="card-icon icon-students">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3>الطلاب المسجلين</h3>
                    <div class="card-value" id="statsStudents">0</div>
                    <p>طالب نشط</p>
                </div>
                
                <div class="dashboard-card">
                    <div class="card-icon icon-questions">
                        <i class="fas fa-question-circle"></i>
                    </div>
                    <h3>الأسئلة</h3>
                    <div class="card-value" id="statsQuestions">0</div>
                    <p>سؤال في البنك</p>
                </div>
                
                <div class="dashboard-card">
                    <div class="card-icon icon-exams">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <h3>الاختبارات</h3>
                    <div class="card-value" id="statsExams">0</div>
                    <p>اختبار منشور</p>
                </div>
                
                <div class="dashboard-card">
                    <div class="card-icon icon-results">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h3>النتائج</h3>
                    <div class="card-value" id="statsResults">0</div>
                    <p>نتيجة مسجلة</p>
                </div>
            </div>
            
            <div class="table-container">
                <h2 style="margin-bottom: 20px; color: var(--text-dark);">
                    <i class="fas fa-history"></i> أحدث النتائج
                </h2>
                <table class="data-table" id="recentResultsTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>الطالب</th>
                            <th>الاختبار</th>
                            <th>الدرجة</th>
                            <th>النسبة</th>
                            <th>التاريخ</th>
                            <th>الحالة</th>
                        </tr>
                    </thead>
                    <tbody id="recentResultsBody">
                        <!-- يتم تعبئتها جافاسكريبت -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- إدارة الطلاب -->
        <div class="teacher-content" id="studentsTab">
            <div class="table-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: var(--text-dark);">
                        <i class="fas fa-users"></i> إدارة الطلاب
                    </h2>
                    <div>
                        <button class="btn btn-primary" onclick="showAddStudentModal()">
                            <i class="fas fa-user-plus"></i> إضافة طالب
                        </button>
                        <label class="btn btn-primary" style="margin-right: 10px; cursor: pointer;">
                            <i class="fas fa-file-excel"></i> استيراد من Excel
                            <input type="file" id="excelFileInput" accept=".xlsx,.xls,.csv" 
                                   style="display: none;" onchange="importExcelStudents(event)">
                        </label>
                    </div>
                </div>
                
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>الرقم المدني</th>
                            <th>الاسم</th>
                            <th>الصف</th>
                            <th>تاريخ التسجيل</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTableBody">
                        <!-- يتم تعبئتها جافاسكريبت -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- إنشاء الأسئلة -->
        <div class="teacher-content" id="questionsTab">
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 30px;">
                <!-- نموذج إضافة سؤال -->
                <div class="table-container">
                    <h2 style="margin-bottom: 20px; color: var(--text-dark);">
                        <i class="fas fa-plus-circle"></i> إنشاء سؤال جديد
                    </h2>
                    
                    <div class="form-group">
                        <label class="form-label">نص السؤال</label>
                        <textarea class="form-input" id="questionText" rows="4" 
                                  placeholder="أدخل نص السؤال هنا..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">نوع السؤال</label>
                        <select class="form-input" id="questionType" onchange="toggleQuestionOptions()">
                            <option value="mcq">اختيار من متعدد</option>
                            <option value="essay">سؤال مقالي</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">المادة</label>
                        <input type="text" class="form-input" id="questionSubject" 
                               placeholder="أدخل اسم المادة">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">الدرجة</label>
                        <input type="number" class="form-input" id="questionScore" 
                               value="1" min="1" max="100">
                    </div>
                    
                    <!-- خيارات MCQ -->
                    <div id="mcqOptionsSection">
                        <h3 style="margin: 20px 0 10px; color: var(--text-dark);">
                            <i class="fas fa-list-ol"></i> خيارات الإجابة
                        </h3>
                        
                        <div id="mcqOptionsContainer">
                            <!-- يتم إضافة الخيارات هنا -->
                        </div>
                        
                        <button class="btn btn-primary" onclick="addMcqOption()" 
                                style="margin-top: 10px; width: 100%;">
                            <i class="fas fa-plus"></i> إضافة خيار
                        </button>
                    </div>
                    
                    <button class="btn btn-primary" onclick="saveQuestion()" 
                            style="margin-top: 30px; width: 100%;">
                        <i class="fas fa-save"></i> حفظ السؤال
                    </button>
                </div>
                
                <!-- بنك الأسئلة -->
                <div class="table-container">
                    <h2 style="margin-bottom: 20px; color: var(--text-dark);">
                        <i class="fas fa-database"></i> بنك الأسئلة
                    </h2>
                    
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>السؤال</th>
                                <th>النوع</th>
                                <th>المادة</th>
                                <th>الدرجة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="questionsTableBody">
                            <!-- يتم تعبئتها جافاسكريبت -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- إدارة الاختبارات -->
        <div class="teacher-content" id="examsTab">
            <div class="table-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: var(--text-dark);">
                        <i class="fas fa-file-alt"></i> إدارة الاختبارات
                    </h2>
                    <button class="btn btn-primary" onclick="showCreateExamModal()">
                        <i class="fas fa-plus-circle"></i> إنشاء اختبار جديد
                    </button>
                </div>
                
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>اسم الاختبار</th>
                            <th>المادة</th>
                            <th>كود الاختبار</th>
                            <th>الصف</th>
                            <th>عدد الأسئلة</th>
                            <th>المدة</th>
                            <th>الحالة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="examsTableBody">
                        <!-- يتم تعبئتها جافاسكريبت -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- النتائج والتصحيح -->
        <div class="teacher-content" id="resultsTab">
            <div class="table-container">
                <h2 style="margin-bottom: 20px; color: var(--text-dark);">
                    <i class="fas fa-chart-bar"></i> النتائج والتصحيح
                </h2>
                
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>الطالب</th>
                            <th>الاختبار</th>
                            <th>الدرجة</th>
                            <th>النسبة</th>
                            <th>التاريخ</th>
                            <th>حالة المقالي</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                        <!-- يتم تعبئتها جافاسكريبت -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- الإعدادات -->
        <div class="teacher-content" id="settingsTab">
            <div class="table-container">
                <h2 style="margin-bottom: 20px; color: var(--text-dark);">
                    <i class="fas fa-cog"></i> الإعدادات
                </h2>
                
                <div style="display: grid; gap: 20px;">
                    <div style="background: white; padding: 25px; border-radius: var(--radius-md);">
                        <h3 style="margin-bottom: 15px; color: var(--text-dark);">
                            <i class="fas fa-lock"></i> تغيير كلمة مرور المعلم
                        </h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label class="form-label">كلمة المرور الحالية</label>
                                <input type="password" class="form-input" id="currentPassword">
                            </div>
                            <div class="form-group">
                                <label class="form-label">كلمة المرور الجديدة</label>
                                <input type="password" class="form-input" id="newPassword">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="changeTeacherPassword()" 
                                style="margin-top: 15px;">
                            <i class="fas fa-save"></i> حفظ التغييرات
                        </button>
                    </div>
                    
                    <div style="background: white; padding: 25px; border-radius: var(--radius-md);">
                        <h3 style="margin-bottom: 15px; color: var(--text-dark);">
                            <i class="fas fa-database"></i> إدارة البيانات
                        </h3>
                        <div style="display: flex; gap: 15px;">
                            <button class="btn btn-primary" onclick="backupData()">
                                <i class="fas fa-download"></i> نسخ احتياطي
                            </button>
                            <button class="btn btn-primary" onclick="restoreData()">
                                <i class="fas fa-upload"></i> استعادة بيانات
                            </button>
                            <button class="btn btn-primary" onclick="exportResults()">
                                <i class="fas fa-file-excel"></i> تصدير النتائج
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ===== نافذة تصحيح المقالي ===== -->
    <div class="correction-modal" id="correctionModal">
        <div class="correction-container">
            <div class="correction-header">
                <div>
                    <h2 style="color: white; margin: 0;">
                        <i class="fas fa-pen-alt"></i> تصحيح الإجابات المقالية
                    </h2>
                    <p style="color: rgba(255, 255, 255, 0.9); margin-top: 5px;">
                        الطالب: <span id="correctionStudentName">-</span> | الاختبار: <span id="correctionExamName">-</span>
                    </p>
                </div>
                <div>
                    <button class="btn-icon" style="background: #f56565;" onclick="closeCorrection()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="correction-body">
                <div class="student-info-panel">
                    <h3 style="margin-bottom: 20px; color: var(--text-dark);">
                        <i class="fas fa-info-circle"></i> معلومات التصحيح
                    </h3>
                    <div style="margin-bottom: 20px;">
                        <div style="color: var(--text-light); font-size: 0.9rem;">الدرجة الحالية</div>
                        <div style="font-size: 2rem; font-weight: 700; color: #667eea;" id="currentScore">0/0</div>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <div style="color: var(--text-light); font-size: 0.9rem;">الدرجة المستحقة</div>
                        <div style="font-size: 1.5rem; font-weight: 600; color: #48bb78;" id="totalScore">0</div>
                    </div>
                    <div id="essayQuestionsList">
                        <!-- قائمة الأسئلة المقالية -->
                    </div>
                </div>
                
                <div class="answer-panel">
                    <div class="score-controls">
                        <span style="font-weight: 600; color: var(--text-dark);">الدرجة:</span>
                        <input type="number" class="score-input" id="scoreInput" min="0" max="10">
                        <button class="btn-icon" style="background: #48bb78;" onclick="saveEssayScore()">
                            <i class="fas fa-save"></i>
                        </button>
                    </div>
                    
                    <h3 style="margin-bottom: 20px; color: var(--text-dark);" id="currentQuestionTitle">
                        السؤال المقالي
                    </h3>
                    
                    <div id="essayAnswerText" style="font-size: 1.1rem; line-height: 1.6; color: var(--text-dark);">
                        إجابة الطالب تظهر هنا...
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <h4 style="margin-bottom: 15px; color: var(--text-dark);">
                            <i class="fas fa-paint-brush"></i> لوحة التصحيح
                        </h4>
                        <canvas id="correctionCanvas" width="800" height="300" 
                                style="width: 100%; height: 300px; border: 2px solid #e2e8f0; border-radius: var(--radius-md); cursor: crosshair;"></canvas>
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="clearCorrectionCanvas()">
                                <i class="fas fa-eraser"></i> مسح
                            </button>
                            <button class="btn btn-primary" onclick="undoCorrection()">
                                <i class="fas fa-undo"></i> تراجع
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="navigation-controls">
                <button class="nav-btn" onclick="previousStudentCorrection()">
                    <i class="fas fa-arrow-right"></i>
                </button>
                <button class="nav-btn" onclick="nextStudentCorrection()">
                    <i class="fas fa-arrow-left"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- ===== مكتبات إضافية ===== -->
    <script>
        // 🔥 إعدادات Firebase - ضع معلوماتك هنا
        const firebaseConfig = {
            apiKey: "AIzaSyAvdFgW-zTkZ7oq7wI3MjgKfX-TqgAUnyQ",
            authDomain: "teacher-app-1a576.firebaseapp.com",
            projectId: "teacher-app-1a576",
            storageBucket: "teacher-app-1a576.firebasestorage.app",
            messagingSenderId: "194924958624",
            appId: "1:194924958624:web:aa1096b5d70444850413a1"
        };
        
        // ===== المتغيرات العامة =====
        let db;
        let isOnline = false;
        let students = [];
        let questions = [];
        let exams = [];
        let results = [];
        let currentStudent = null;
        let currentExam = null;
        let studentAnswers = [];
        let currentQuestionIndex = 0;
        let examTimer = null;
        let timeRemaining = 0;
        let teacherPassword = "112233"; // كلمة المرور الافتراضية
        let currentStudentIndex = 0;
        let currentEssayIndex = 0;
        let correctionCtx = null;
        let correctionHistory = [];
        
        // ===== تهيئة النظام =====
        document.addEventListener('DOMContentLoaded', async function() {
            // إخفاء شاشة التحميل بعد 2 ثانية
            setTimeout(() => {
                document.getElementById('splashScreen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('splashScreen').style.display = 'none';
                }, 500);
            }, 2000);
            
            // تهيئة Firebase
            await initFirebase();
            
            // تحميل البيانات
            loadLocalData();
            
            // عرض واجهة الطالب (الافتراضية)
            showStudentMode();
            
            // تهيئة لوحة التصحيح
            initCorrectionCanvas();
        });
        
        async function initFirebase() {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                isOnline = true;
                console.log('✅ Firebase متصل بنجاح');
                
                // تحميل البيانات من السحابة
                await loadCloudData();
                
                // الاستماع للتحديثات
                setupRealtimeListeners();
                
            } catch (error) {
                console.error('❌ خطأ في الاتصال بـ Firebase:', error);
                isOnline = false;
            }
        }
        
        // ===== دوال المزامنة =====
        async function loadCloudData() {
            try {
                // الطلاب
                const studentsSnapshot = await db.collection('students').get();
                students = studentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                localStorage.setItem('students', JSON.stringify(students));
                
                // الأسئلة
                const questionsSnapshot = await db.collection('questions').get();
                questions = questionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                localStorage.setItem('questions', JSON.stringify(questions));
                
                // الاختبارات
                const examsSnapshot = await db.collection('exams').get();
                exams = examsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                localStorage.setItem('exams', JSON.stringify(exams));
                
                // النتائج
                const resultsSnapshot = await db.collection('results').get();
                results = resultsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                localStorage.setItem('results', JSON.stringify(results));
                
                console.log('✅ تم تحميل البيانات من السحابة');
                
            } catch (error) {
                console.error('❌ خطأ في تحميل البيانات:', error);
            }
        }
        
        function loadLocalData() {
            students = JSON.parse(localStorage.getItem('students')) || [];
            questions = JSON.parse(localStorage.getItem('questions')) || [];
            exams = JSON.parse(localStorage.getItem('exams')) || [];
            results = JSON.parse(localStorage.getItem('results')) || [];
        }
        
        function setupRealtimeListeners() {
            // الاستماع للتحديثات على الطلاب
            db.collection('students').onSnapshot((snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const studentData = { id: change.doc.id, ...change.doc.data() };
                    
                    if (change.type === 'added') {
                        students.push(studentData);
                    } else if (change.type === 'modified') {
                        const index = students.findIndex(s => s.id === studentData.id);
                        if (index !== -1) students[index] = studentData;
                    } else if (change.type === 'removed') {
                        students = students.filter(s => s.id !== studentData.id);
                    }
                });
                localStorage.setItem('students', JSON.stringify(students));
                if (currentMode === 'teacher') updateDashboard();
            });
            
            // استمع للتحديثات الأخرى...
        }
        
        async function saveToCloud(collection, data) {
            if (!isOnline) return null;
            
            try {
                let docRef;
                if (data.id) {
                    const { id, ...dataWithoutId } = data;
                    docRef = await db.collection(collection).doc(id).set(dataWithoutId);
                } else {
                    docRef = await db.collection(collection).add(data);
                    data.id = docRef.id;
                }
                return data.id || docRef.id;
            } catch (error) {
                console.error(`❌ خطأ في حفظ ${collection}:`, error);
                return null;
            }
        }
        
        // ===== إدارة الواجهات =====
        function showStudentMode() {
            document.getElementById('studentContainer').style.display = 'block';
            document.getElementById('teacherContainer').style.display = 'none';
            currentMode = 'student';
        }
        
        function showTeacherMode() {
            document.getElementById('studentContainer').style.display = 'none';
            document.getElementById('teacherContainer').style.display = 'block';
            currentMode = 'teacher';
            updateDashboard();
        }
        
        function showTeacherLogin() {
            document.getElementById('teacherPasswordModal').classList.add('active');
        }
        
        function checkTeacherPassword() {
            const password = document.getElementById('teacherPassword').value;
            if (password === teacherPassword) {
                document.getElementById('teacherPasswordModal').classList.remove('active');
                showTeacherMode();
            } else {
                document.getElementById('passwordError').style.display = 'block';
            }
        }
        
        function changeTeacherPassword() {
            const current = document.getElementById('currentPassword').value;
            const newPass = document.getElementById('newPassword').value;
            
            if (current === teacherPassword) {
                teacherPassword = newPass;
                alert('✅ تم تغيير كلمة المرور بنجاح');
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
            } else {
                alert('❌ كلمة المرور الحالية غير صحيحة');
            }
        }
        
        function switchToStudentMode() {
            showStudentMode();
        }
        
        // ===== إدارة التبويبات =====
        function showTeacherTab(tabId) {
            // إخفاء جميع المحتويات
            document.querySelectorAll('.teacher-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // إزالة النشاط من جميع الأزرار
            document.querySelectorAll('.teacher-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // إظهار المحتوى المحدد
            document.getElementById(tabId + 'Tab').classList.add('active');
            
            // تفعيل الزر المحدد
            event.target.classList.add('active');
            
            // تحديث المحتوى إذا لزم
            if (tabId === 'dashboard') updateDashboard();
            if (tabId === 'students') updateStudentsTable();
            if (tabId === 'questions') updateQuestionsTable();
            if (tabId === 'exams') updateExamsTable();
            if (tabId === 'results') updateResultsTable();
        }
        
        // ===== لوحة التحكم =====
        function updateDashboard() {
            document.getElementById('statsStudents').textContent = students.length;
            document.getElementById('statsQuestions').textContent = questions.length;
            document.getElementById('statsExams').textContent = exams.length;
            document.getElementById('statsResults').textContent = results.length;
            
            // عرض أحدث النتائج
            const recentResults = results.slice(-5).reverse();
            const tbody = document.getElementById('recentResultsBody');
            tbody.innerHTML = '';
            
            recentResults.forEach((result, index) => {
                const percentage = ((result.score / result.totalScore) * 100).toFixed(1);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${result.studentName}</td>
                    <td>${result.examName}</td>
                    <td>${result.score}/${result.totalScore}</td>
                    <td style="color: ${percentage >= 50 ? '#48bb78' : '#f56565'}; font-weight: 600;">
                        ${percentage}%
                    </td>
                    <td>${new Date(result.submittedAt).toLocaleDateString('ar-SA')}</td>
                    <td>
                        <span style="background: ${result.status === 'graded' ? '#48bb78' : '#ed8936'}; 
                              color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">
                            ${result.status === 'graded' ? 'مصحح' : 'بانتظار التصحيح'}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // ===== إدارة الطلاب =====
        function updateStudentsTable() {
            const tbody = document.getElementById('studentsTableBody');
            tbody.innerHTML = '';
            
            students.forEach((student, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${student.civilId}</td>
                    <td>${student.name}</td>
                    <td>${student.class || 'غير محدد'}</td>
                    <td>${new Date(student.createdAt).toLocaleDateString('ar-SA')}</td>
                    <td>
                        <button class="btn-icon btn-edit" onclick="editStudent('${student.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon btn-delete" onclick="deleteStudent('${student.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function showAddStudentModal() {
            const name = prompt('أدخل اسم الطالب:');
            if (!name) return;
            
            const civilId = prompt('أدخل الرقم المدني:');
            if (!civilId) return;
            
            const className = prompt('اختر الصف:', 'أول متوسط,ثاني متوسط,ثالث متوسط');
            
            const newStudent = {
                name,
                civilId,
                class: className,
                createdAt: new Date().toISOString()
            };
            
            students.push(newStudent);
            saveToCloud('students', newStudent);
            localStorage.setItem('students', JSON.stringify(students));
            updateStudentsTable();
            alert('✅ تم إضافة الطالب بنجاح');
        }
        
        async function importExcelStudents(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);
                    
                    let imported = 0;
                    for (const row of jsonData) {
                        if (row['الرقم المدني'] && row['الاسم']) {
                            const newStudent = {
                                civilId: row['الرقم المدني'].toString(),
                                name: row['الاسم'],
                                class: row['الصف'] || 'غير محدد',
                                createdAt: new Date().toISOString()
                            };
                            
                            students.push(newStudent);
                            await saveToCloud('students', newStudent);
                            imported++;
                        }
                    }
                    
                    localStorage.setItem('students', JSON.stringify(students));
                    updateStudentsTable();
                    alert(`✅ تم استيراد ${imported} طالب بنجاح`);
                    
                } catch (error) {
                    alert('❌ خطأ في استيراد الملف: ' + error.message);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // ===== إدارة الأسئلة =====
        function toggleQuestionOptions() {
            const type = document.getElementById('questionType').value;
            if (type === 'mcq') {
                document.getElementById('mcqOptionsSection').style.display = 'block';
                initMcqOptions();
            } else {
                document.getElementById('mcqOptionsSection').style.display = 'none';
            }
        }
        
        function initMcqOptions() {
            const container = document.getElementById('mcqOptionsContainer');
            container.innerHTML = `
                <div class="option-item" style="margin-bottom: 10px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="radio" name="correctOption" value="0" checked>
                        <input type="text" class="form-input" placeholder="النص الأول" 
                               style="flex: 1;" id="optionText0">
                    </div>
                </div>
                <div class="option-item" style="margin-bottom: 10px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="radio" name="correctOption" value="1">
                        <input type="text" class="form-input" placeholder="النص الثاني" 
                               style="flex: 1;" id="optionText1">
                    </div>
                </div>
            `;
        }
        
        function addMcqOption() {
            const container = document.getElementById('mcqOptionsContainer');
            const count = container.children.length;
            
            const optionDiv = document.createElement('div');
            optionDiv.className = 'option-item';
            optionDiv.style.marginBottom = '10px';
            optionDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="radio" name="correctOption" value="${count}">
                    <input type="text" class="form-input" placeholder="خيار جديد" 
                           style="flex: 1;" id="optionText${count}">
                    <button class="btn-icon btn-delete" onclick="removeMcqOption(${count})" 
                            style="width: 35px; height: 35px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(optionDiv);
        }
        
        function removeMcqOption(index) {
            const container = document.getElementById('mcqOptionsContainer');
            if (container.children.length > 2) {
                container.children[index].remove();
                
                // إعادة ترقيم الخيارات
                const options = container.querySelectorAll('input[type="radio"], input[type="text"]');
                options.forEach((input, i) => {
                    if (i % 2 === 0) {
                        input.value = Math.floor(i / 2);
                    } else {
                        input.id = `optionText${Math.floor(i / 2)}`;
                    }
                });
            }
        }
        
        async function saveQuestion() {
            const text = document.getElementById('questionText').value.trim();
            const type = document.getElementById('questionType').value;
            const subject = document.getElementById('questionSubject').value.trim();
            const score = parseInt(document.getElementById('questionScore').value);
            
            if (!text || !subject || !score) {
                alert('❌ الرجاء ملء جميع الحقول المطلوبة');
                return;
            }
            
            const question = {
                text,
                type,
                subject,
                score,
                createdAt: new Date().toISOString()
            };
            
            if (type === 'mcq') {
                const options = [];
                const optionInputs = document.querySelectorAll('#mcqOptionsContainer input[type="text"]');
                const correctIndex = parseInt(document.querySelector('input[name="correctOption"]:checked').value);
                
                optionInputs.forEach((input, index) => {
                    if (input.value.trim()) {
                        options.push({
                            text: input.value.trim(),
                            isCorrect: index === correctIndex
                        });
                    }
                });
                
                if (options.length < 2) {
                    alert('❌ يجب إضافة خيارين على الأقل');
                    return;
                }
                
                question.options = options;
            }
            
            questions.push(question);
            await saveToCloud('questions', question);
            localStorage.setItem('questions', JSON.stringify(questions));
            
            // مسح الحقول
            document.getElementById('questionText').value = '';
            document.getElementById('questionSubject').value = '';
            document.getElementById('questionScore').value = '1';
            
            updateQuestionsTable();
            alert('✅ تم حفظ السؤال بنجاح');
        }
        
        function updateQuestionsTable() {
            const tbody = document.getElementById('questionsTableBody');
            tbody.innerHTML = '';
            
            questions.forEach((question, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td style="max-width: 300px;">${question.text.substring(0, 80)}${question.text.length > 80 ? '...' : ''}</td>
                    <td>
                        <span style="background: ${question.type === 'mcq' ? '#667eea' : '#ed8936'}; 
                              color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">
                            ${question.type === 'mcq' ? 'اختيار' : 'مقالي'}
                        </span>
                    </td>
                    <td>${question.subject}</td>
                    <td>
                        <input type="number" value="${question.score}" min="1" max="100" 
                               style="width: 70px; padding: 5px; border: 1px solid #e2e8f0; border-radius: 4px;"
                               onchange="updateQuestionScore(${index}, this.value)">
                    </td>
                    <td>
                        <button class="btn-icon btn-edit" onclick="editQuestion(${index})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon btn-delete" onclick="deleteQuestion(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function updateQuestionScore(index, newScore) {
            questions[index].score = parseInt(newScore);
            saveToCloud('questions', questions[index]);
            localStorage.setItem('questions', JSON.stringify(questions));
            
            // تحديث جميع النتائج المتأثرة
            results.forEach(result => {
                if (result.answers) {
                    result.answers.forEach(answer => {
                        if (answer.questionId === questions[index].id) {
                            answer.maxScore = parseInt(newScore);
                        }
                    });
                }
            });
            
            localStorage.setItem('results', JSON.stringify(results));
            alert('✅ تم تحديث درجة السؤال لجميع الطلاب');
        }
        
        // ===== إدارة الاختبارات =====
        function updateExamsTable() {
            const tbody = document.getElementById('examsTableBody');
            tbody.innerHTML = '';
            
            exams.forEach((exam, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${exam.name}</td>
                    <td>${exam.subject}</td>
                    <td><strong>${exam.code}</strong></td>
                    <td>${exam.class || 'غير محدد'}</td>
                    <td>${exam.questions ? exam.questions.length : 0}</td>
                    <td>${exam.duration} دقيقة</td>
                    <td>
                        <span style="background: ${exam.status === 'active' ? '#48bb78' : '#f56565'}; 
                              color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">
                            ${exam.status === 'active' ? 'نشط' : 'مغلق'}
                        </span>
                    </td>
                    <td>
                        <button class="btn-icon btn-edit" onclick="editExam(${index})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon btn-delete" onclick="deleteExam(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function showCreateExamModal() {
            const name = prompt('اسم الاختبار:');
            if (!name) return;
            
            const subject = prompt('المادة:');
            if (!subject) return;
            
            const code = prompt('كود الاختبار (رقم أو رقمين):');
            if (!code) return;
            
            const duration = prompt('المدة بالدقائق:', '60');
            if (!duration) return;
            
            const className = prompt('الصف:', 'أول متوسط,ثاني متوسط,ثالث متوسط');
            if (!className) return;
            
            // اختيار الأسئلة
            let selectedQuestions = [];
            let questionList = 'اختر الأسئلة (اكتب أرقام الأسئلة مفصولة بفاصلة):\n\n';
            questions.forEach((q, i) => {
                questionList += `${i + 1}. ${q.text.substring(0, 50)}... (${q.type === 'mcq' ? 'اختيار' : 'مقالي'})\n`;
            });
            
            const selected = prompt(questionList);
            if (selected) {
                selected.split(',').forEach(num => {
                    const index = parseInt(num.trim()) - 1;
                    if (questions[index]) {
                        selectedQuestions.push(questions[index].id);
                    }
                });
            }
            
            const exam = {
                name,
                subject,
                code,
                duration: parseInt(duration),
                class: className,
                questions: selectedQuestions,
                status: 'active',
                createdAt: new Date().toISOString()
            };
            
            exams.push(exam);
            saveToCloud('exams', exam);
            localStorage.setItem('exams', JSON.stringify(exams));
            updateExamsTable();
            alert('✅ تم إنشاء الاختبار بنجاح');
        }
        
        // ===== النتائج والتصحيح =====
        function updateResultsTable() {
            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = '';
            
            results.forEach((result, index) => {
                const percentage = ((result.score / result.totalScore) * 100).toFixed(1);
                const hasEssay = result.answers?.some(a => a.type === 'essay');
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${result.studentName}</td>
                    <td>${result.examName}</td>
                    <td>${result.score}/${result.totalScore}</td>
                    <td style="color: ${percentage >= 50 ? '#48bb78' : '#f56565'}; font-weight: 600;">
                        ${percentage}%
                    </td>
                    <td>${new Date(result.submittedAt).toLocaleDateString('ar-SA')}</td>
                    <td>
                        ${hasEssay ? 
                            `<span style="background: ${result.status === 'graded' ? '#48bb78' : '#ed8936'}; 
                                  color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">
                                ${result.status === 'graded' ? 'مصحح' : 'يحتاج تصحيح'}
                            </span>` : 
                            '<span style="color: #718096;">-</span>'
                        }
                    </td>
                    <td>
                        ${hasEssay && result.status !== 'graded' ? 
                            `<button class="btn-icon btn-correct" onclick="startCorrection(${index})">
                                <i class="fas fa-pen-alt"></i>
                            </button>` : ''
                        }
                        <button class="btn-icon btn-view" onclick="viewResultDetails(${index})">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-icon btn-print" onclick="printResult(${index})">
                            <i class="fas fa-print"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function startCorrection(resultIndex) {
            currentStudentIndex = resultIndex;
            currentEssayIndex = 0;
            
            const result = results[resultIndex];
            document.getElementById('correctionStudentName').textContent = result.studentName;
            document.getElementById('correctionExamName').textContent = result.examName;
            
            // عرض الأسئلة المقالية
            const essayQuestions = result.answers?.filter(a => a.type === 'essay') || [];
            const listDiv = document.getElementById('essayQuestionsList');
            listDiv.innerHTML = '<h4 style="margin-bottom: 10px;">الأسئلة المقالية:</h4>';
            
            essayQuestions.forEach((q, i) => {
                const questionDiv = document.createElement('div');
                questionDiv.style.padding = '10px';
                questionDiv.style.marginBottom = '5px';
                questionDiv.style.borderRadius = '5px';
                questionDiv.style.background = i === currentEssayIndex ? '#e2e8f0' : 'white';
                questionDiv.style.cursor = 'pointer';
                questionDiv.onclick = () => {
                    currentEssayIndex = i;
                    loadEssayQuestion(i);
                    updateEssayList();
                };
                questionDiv.innerHTML = `
                    <div style="font-weight: 600;">السؤال ${i + 1}</div>
                    <div style="font-size: 0.9rem; color: #718096;">${q.score}/${q.maxScore}</div>
                `;
                listDiv.appendChild(questionDiv);
            });
            
            // تحميل السؤال الأول
            loadEssayQuestion(0);
            updateEssayList();
            
            // فتح نافذة التصحيح
            document.getElementById('correctionModal').classList.add('active');
        }
        
        function loadEssayQuestion(index) {
            const result = results[currentStudentIndex];
            const essayQuestions = result.answers?.filter(a => a.type === 'essay') || [];
            
            if (essayQuestions[index]) {
                const q = essayQuestions[index];
                document.getElementById('currentQuestionTitle').textContent = `السؤال ${index + 1}: ${q.questionText.substring(0, 100)}...`;
                document.getElementById('essayAnswerText').textContent = q.answer || 'لم يتم الإجابة';
                document.getElementById('scoreInput').value = q.score || 0;
                document.getElementById('scoreInput').max = q.maxScore;
                
                // تحديث الدرجات
                const totalScore = essayQuestions.reduce((sum, q) => sum + (q.score || 0), 0);
                const mcqScore = result.answers?.filter(a => a.type === 'mcq').reduce((sum, a) => sum + (a.score || 0), 0) || 0;
                
                document.getElementById('currentScore').textContent = `${mcqScore + totalScore}/${result.totalScore}`;
                document.getElementById('totalScore').textContent = q.maxScore;
            }
        }
        
        function updateEssayList() {
            const result = results[currentStudentIndex];
            const essayQuestions = result.answers?.filter(a => a.type === 'essay') || [];
            
            const items = document.querySelectorAll('#essayQuestionsList > div');
            items.forEach((div, i) => {
                if (i === 0) return; // تخطي العنوان
                div.style.background = (i - 1) === currentEssayIndex ? '#e2e8f0' : 'white';
            });
        }
        
        function initCorrectionCanvas() {
            const canvas = document.getElementById('correctionCanvas');
            correctionCtx = canvas.getContext('2d');
            
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;
            
            canvas.addEventListener('mousedown', (e) => {
                isDrawing = true;
                [lastX, lastY] = [e.offsetX, e.offsetY];
                saveCanvasState();
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (!isDrawing) return;
                
                correctionCtx.strokeStyle = '#f56565';
                correctionCtx.lineWidth = 2;
                correctionCtx.lineCap = 'round';
                
                correctionCtx.beginPath();
                correctionCtx.moveTo(lastX, lastY);
                correctionCtx.lineTo(e.offsetX, e.offsetY);
                correctionCtx.stroke();
                
                [lastX, lastY] = [e.offsetX, e.offsetY];
            });
            
            canvas.addEventListener('mouseup', () => isDrawing = false);
            canvas.addEventListener('mouseout', () => isDrawing = false);
            
            // أحداث اللمس
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                isDrawing = true;
                [lastX, lastY] = [touch.clientX - rect.left, touch.clientY - rect.top];
                saveCanvasState();
            });
            
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (!isDrawing) return;
                
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;
                
                correctionCtx.strokeStyle = '#f56565';
                correctionCtx.lineWidth = 2;
                correctionCtx.lineCap = 'round';
                
                correctionCtx.beginPath();
                correctionCtx.moveTo(lastX, lastY);
                correctionCtx.lineTo(x, y);
                correctionCtx.stroke();
                
                [lastX, lastY] = [x, y];
            });
            
            canvas.addEventListener('touchend', () => isDrawing = false);
        }
        
        function saveCanvasState() {
            const canvas = document.getElementById('correctionCanvas');
            correctionHistory.push(correctionCtx.getImageData(0, 0, canvas.width, canvas.height));
        }
        
        function clearCorrectionCanvas() {
            const canvas = document.getElementById('correctionCanvas');
            correctionCtx.clearRect(0, 0, canvas.width, canvas.height);
            saveCanvasState();
        }
        
        function undoCorrection() {
            if (correctionHistory.length > 1) {
                correctionHistory.pop();
                correctionCtx.putImageData(correctionHistory[correctionHistory.length - 1], 0, 0);
            }
        }
        
        function saveEssayScore() {
            const result = results[currentStudentIndex];
            const essayQuestions = result.answers?.filter(a => a.type === 'essay') || [];
            
            if (essayQuestions[currentEssayIndex]) {
                const newScore = parseInt(document.getElementById('scoreInput').value);
                essayQuestions[currentEssayIndex].score = newScore;
                
                // تحديث الدرجة الإجمالية
                const totalEssayScore = essayQuestions.reduce((sum, q) => sum + (q.score || 0), 0);
                const mcqScore = result.answers?.filter(a => a.type === 'mcq').reduce((sum, a) => sum + (a.score || 0), 0) || 0;
                
                result.score = mcqScore + totalEssayScore;
                result.status = 'graded';
                
                // حفظ التحديثات
                saveToCloud('results', result);
                localStorage.setItem('results', JSON.stringify(results));
                
                // تحديث العرض
                loadEssayQuestion(currentEssayIndex);
                alert('✅ تم حفظ الدرجة بنجاح');
            }
        }
        
        function previousStudentCorrection() {
            if (currentStudentIndex > 0) {
                currentStudentIndex--;
                startCorrection(currentStudentIndex);
            }
        }
        
        function nextStudentCorrection() {
            if (currentStudentIndex < results.length - 1) {
                currentStudentIndex++;
                startCorrection(currentStudentIndex);
            }
        }
        
        function closeCorrection() {
            document.getElementById('correctionModal').classList.remove('active');
            updateResultsTable();
        }
        
        function viewResultDetails(index) {
            const result = results[index];
            let details = `
                <h3>تفاصيل نتيجة الطالب: ${result.studentName}</h3>
                <p><strong>الاختبار:</strong> ${result.examName}</p>
                <p><strong>الدرجة:</strong> ${result.score}/${result.totalScore}</p>
                <p><strong>النسبة:</strong> ${((result.score / result.totalScore) * 100).toFixed(1)}%</p>
                <p><strong>وقت التسليم:</strong> ${new Date(result.submittedAt).toLocaleString('ar-SA')}</p>
                <hr>
                <h4>الإجابات:</h4>
            `;
            
            result.answers?.forEach((answer, i) => {
                details += `
                    <div style="border: 1px solid #e2e8f0; padding: 15px; margin: 10px 0; border-radius: 8px;">
                        <p><strong>السؤال ${i + 1}:</strong> ${answer.questionText}</p>
                        <p><strong>الإجابة:</strong> ${answer.answer || '(لم يتم الإجابة)'}</p>
                        <p><strong>الدرجة:</strong> ${answer.score}/${answer.maxScore}</p>
                    </div>
                `;
            });
            
            alert(details);
        }
        
        function printResult(index) {
            const result = results[index];
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html dir="rtl">
                <head>
                    <title>نتيجة الطالب - ${result.studentName}</title>
                    <style>
                        body { font-family: 'Cairo', sans-serif; padding: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .info { margin-bottom: 20px; }
                        .question { border: 1px solid #000; padding: 10px; margin: 10px 0; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>نتيجة الاختبار</h1>
                        <h2>${result.examName}</h2>
                    </div>
                    <div class="info">
                        <p><strong>الطالب:</strong> ${result.studentName}</p>
                        <p><strong>الدرجة:</strong> ${result.score}/${result.totalScore}</p>
                        <p><strong>النسبة:</strong> ${((result.score / result.totalScore) * 100).toFixed(1)}%</p>
                        <p><strong>التاريخ:</strong> ${new Date(result.submittedAt).toLocaleString('ar-SA')}</p>
                    </div>
                    <h3>الإجابات:</h3>
            `);
            
            result.answers?.forEach((answer, i) => {
                printWindow.document.write(`
                    <div class="question">
                        <p><strong>السؤال ${i + 1}:</strong> ${answer.questionText}</p>
                        <p><strong>الإجابة:</strong> ${answer.answer || '(لم يتم الإجابة)'}</p>
                        <p><strong>الدرجة:</strong> ${answer.score}/${answer.maxScore}</p>
                    </div>
                `);
            });
            
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }
        
        // ===== واجهة الطالب - الاختبار =====
        function studentLogin() {
            const civilId = document.getElementById('studentCivilId').value.trim();
            const examCode = document.getElementById('examCode').value.trim();
            
            if (!civilId || !examCode) {
                showAlert('❌ الرجاء إدخال جميع البيانات', 'error');
                return;
            }
            
            // البحث عن الطالب
            const student = students.find(s => s.civilId === civilId);
            if (!student) {
                showAlert('❌ الرقم المدني غير مسجل', 'error');
                return;
            }
            
            // البحث عن الاختبار
            const exam = exams.find(e => e.code === examCode && e.status === 'active');
            if (!exam) {
                showAlert('❌ كود الاختبار غير صحيح', 'error');
                return;
            }
            
            // التحقق من أن الطالب لم يدخل الاختبار من قبل
            const hasTaken = results.some(r => 
                r.studentCivilId === civilId && r.examCode === examCode
            );
            
            if (hasTaken) {
                showAlert('❌ لقد أديت هذا الاختبار من قبل', 'error');
                return;
            }
            
            currentStudent = student;
            currentExam = exam;
            studentAnswers = [];
            currentQuestionIndex = 0;
            
            // تحميل أسئلة الاختبار
            currentExam.questionsData = (currentExam.questions || []).map(qId => 
                questions.find(q => q.id === qId)
            ).filter(q => q);
            
            if (currentExam.questionsData.length === 0) {
                showAlert('❌ لا توجد أسئلة في هذا الاختبار', 'error');
                return;
            }
            
            // تهيئة الإجابات
            currentExam.questionsData.forEach((question) => {
                studentAnswers.push({
                    questionId: question.id,
                    questionText: question.text,
                    type: question.type,
                    answer: '',
                    score: 0,
                    maxScore: question.score
                });
            });
            
            // تعبئة معلومات الاختبار
            document.getElementById('examStudentName').textContent = currentStudent.name;
            document.getElementById('examTestName').textContent = currentExam.name;
            document.getElementById('examSubject').textContent = currentExam.subject;
            document.getElementById('examCodeDisplay').textContent = currentExam.code;
            document.getElementById('examClass').textContent = currentExam.class;
            document.getElementById('examDuration').textContent = currentExam.duration + ' دقيقة';
            document.getElementById('examQuestionsCount').textContent = currentExam.questionsData.length;
            
            // إخفاء شاشة الدخول وإظهار الاختبار
            document.getElementById('studentLoginScreen').style.display = 'none';
            document.getElementById('examContainer').style.display = 'block';
            
            // بدء المؤقت
            startExamTimer();
            
            // عرض السؤال الأول
            displayQuestion(0);
        }
        
        function showAlert(message, type = 'warning') {
            const alertDiv = document.getElementById('loginAlert');
            const messageSpan = document.getElementById('alertMessage');
            
            alertDiv.className = `alert alert-${type}`;
            messageSpan.textContent = message;
            alertDiv.style.display = 'flex';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }
        
        function startExamTimer() {
            timeRemaining = currentExam.duration * 60;
            updateTimerDisplay();
            
            examTimer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(examTimer);
                    submitExam();
                    alert('⏰ انتهى وقت الاختبار!');
                }
            }, 1000);
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeRemaining').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function displayQuestion(index) {
            // إخفاء جميع الأسئلة
            document.querySelectorAll('.question-card').forEach(card => {
                card.classList.remove('active');
            });
            
            const question = currentExam.questionsData[index];
            if (!question) return;
            
            // إنشاء كارد السؤال إذا لم يكن موجوداً
            let questionCard = document.getElementById(`question-${index}`);
            if (!questionCard) {
                questionCard = document.createElement('div');
                questionCard.className = 'question-card';
                questionCard.id = `question-${index}`;
                
                let questionHTML = `
                    <div class="question-header">
                        <div class="question-number">${index + 1}</div>
                        <div class="question-text">${question.text}</div>
                    </div>
                `;
                
                if (question.type === 'mcq' && question.options) {
                    questionHTML += `<div class="options-container">`;
                    question.options.forEach((option, optIndex) => {
                        questionHTML += `
                            <label class="option-label">
                                <input type="radio" name="question_${index}" 
                                       value="${option.text}" class="option-input"
                                       onchange="selectAnswer(${index}, '${option.text}')">
                                <span class="option-text">${option.text}</span>
                            </label>
                        `;
                    });
                    questionHTML += `</div>`;
                } else if (question.type === 'essay') {
                    questionHTML += `
                        <div class="form-group">
                            <textarea class="form-input" id="essay_${index}" rows="4" 
                                      placeholder="اكتب إجابتك هنا..."
                                      oninput="saveEssayAnswer(${index}, this.value)"></textarea>
                        </div>
                    `;
                }
                
                questionCard.innerHTML = questionHTML;
                document.getElementById('questionsContainer').appendChild(questionCard);
            }
            
            // إظهار السؤال الحالي
            questionCard.classList.add('active');
            
            // تحديث شريط التقدم
            const progress = ((index + 1) / currentExam.questionsData.length) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
            
            // تحديث أزرار التنقل
            document.getElementById('prevBtn').disabled = index === 0;
            document.getElementById('nextBtn').disabled = index === currentExam.questionsData.length - 1;
            
            // استعادة الإجابة السابقة
            const currentAnswer = studentAnswers[index].answer;
            if (question.type === 'mcq') {
                const radio = questionCard.querySelector(`input[value="${currentAnswer}"]`);
                if (radio) {
                    radio.checked = true;
                    radio.parentElement.classList.add('selected');
                }
            } else if (question.type === 'essay') {
                const textarea = questionCard.querySelector('textarea');
                if (textarea) {
                    textarea.value = currentAnswer;
                }
            }
        }
        
        function selectAnswer(questionIndex, answer) {
            studentAnswers[questionIndex].answer = answer;
            
            // تحديث المظهر
            const questionCard = document.getElementById(`question-${questionIndex}`);
            questionCard.querySelectorAll('.option-label').forEach(label => {
                label.classList.remove('selected');
            });
            event.target.closest('.option-label').classList.add('selected');
        }
        
        function saveEssayAnswer(questionIndex, answer) {
            studentAnswers[questionIndex].answer = answer;
        }
        
        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion(currentQuestionIndex);
            }
        }
        
        function nextQuestion() {
            // التحقق من إجابة السؤال الحالي
            const currentAnswer = studentAnswers[currentQuestionIndex];
            if (!currentAnswer.answer.trim()) {
                alert('❌ يجب الإجابة على هذا السؤال قبل الانتقال');
                return;
            }
            
            if (currentQuestionIndex < currentExam.questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion(currentQuestionIndex);
            } else {
                // إذا كان هذا آخر سؤال، تحقق من الإجابة عليه أولاً
                if (!currentAnswer.answer.trim()) {
                    alert('❌ يجب الإجابة على هذا السؤال');
                    return;
                }
                
                // سؤال المستخدم عن التسليم
                if (confirm('هل تريد تسليم الاختبار؟\n\nملاحظة: لا يمكن العودة بعد التسليم')) {
                    submitExam();
                }
            }
        }
        
        async function submitExam() {
            // إيقاف المؤقت
            clearInterval(examTimer);
            
            // حساب النتيجة (للأسئلة الاختيارية فقط)
            let totalScore = 0;
            let totalMaxScore = 0;
            
            studentAnswers.forEach((answer, index) => {
                const question = currentExam.questionsData[index];
                totalMaxScore += question.score;
                
                if (question.type === 'mcq' && question.options) {
                    const correctOption = question.options.find(opt => opt.isCorrect);
                    if (correctOption && answer.answer === correctOption.text) {
                        answer.score = question.score;
                        totalScore += question.score;
                    }
                }
            });
            
            // حفظ النتيجة
            const result = {
                studentId: currentStudent.id,
                studentName: currentStudent.name,
                studentCivilId: currentStudent.civilId,
                examId: currentExam.id,
                examName: currentExam.name,
                examCode: currentExam.code,
                score: totalScore,
                totalScore: totalMaxScore,
                answers: studentAnswers,
                status: studentAnswers.some(a => a.type === 'essay') ? 'pending' : 'graded',
                submittedAt: new Date().toISOString()
            };
            
            results.push(result);
            await saveToCloud('results', result);
            localStorage.setItem('results', JSON.stringify(results));
            
            // إغلاق الاختبار
            document.getElementById('examContainer').style.display = 'none';
            document.getElementById('studentLoginScreen').style.display = 'block';
            
            // لا تظهر النتيجة للطالب
            alert('✅ تم تسليم الاختبار بنجاح\n\nسيتم تصحيح الأسئلة المقالية من قبل المعلم');
        }
        
        // ===== دوال إضافية =====
        function backupData() {
            const backup = {
                students,
                questions,
                exams,
                results,
                backupDate: new Date().toISOString()
            };
            
            const json = JSON.stringify(backup, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `نسخة_احتياطية_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('✅ تم إنشاء نسخة احتياطية بنجاح');
        }
        
        function restoreData() {
            alert('🚧 هذه الميزة قيد التطوير');
        }
        
        function exportResults() {
            if (results.length === 0) {
                alert('❌ لا توجد نتائج لتصديرها');
                return;
            }
            
            const csv = results.map(r => ({
                'اسم الطالب': r.studentName,
                'الرقم المدني': r.studentCivilId,
                'الاختبار': r.examName,
                'كود الاختبار': r.examCode,
                'الدرجة': `${r.score}/${r.totalScore}`,
                'النسبة': `${((r.score / r.totalScore) * 100).toFixed(1)}%`,
                'التاريخ': new Date(r.submittedAt).toLocaleDateString('ar-SA'),
                'الحالة': r.status === 'graded' ? 'مصحح' : 'بانتظار التصحيح'
            }));
            
            const worksheet = XLSX.utils.json_to_sheet(csv);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'النتائج');
            XLSX.writeFile(workbook, `نتائج_الاختبارات_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            alert('✅ تم تصدير النتائج بنجاح');
        }
    </script>
</body>
</html>
